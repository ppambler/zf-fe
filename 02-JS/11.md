| âœï¸ Tangxt | â³ 2020-05-29 | ğŸ·ï¸ JSé«˜é˜¶ç¼–ç¨‹æŠ€å·§ |

# 11-JSé«˜é˜¶ç¼–ç¨‹æŠ€å·§ï¼ˆcomposeå‡½æ•°å®ç°å‡½æ•°è°ƒç”¨æ‰å¹³åŒ–ï¼‰

## â˜…è¿™ä¸œè¥¿æ˜¯ä¸ªå•¥ï¼Ÿ

è¿™ä¸œè¥¿åœ¨é¡¹ç›®é‡Œè¾¹æŒºå¸¸ç”¨çš„ï¼

### â—‡ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªä¸œè¥¿ï¼Ÿ

![å‡½æ•°è°ƒç”¨åµŒå¥—](assets/img/2020-05-29-12-23-13.png)

å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥è¿™æ ·å†™ï¼š

``` js
let x = fn1(5);
x = fn2(x);
x = fn1(x);
x = fn3(x);
console.log(x); //16
```

è™½ç„¶çœ‹ä¸Šå»æ¯”åˆšæ‰çš„å®¹æ˜“æ‡‚äº†ç‚¹ï¼Œä½†æ˜¯é‡å¤šäº†ï¼Œè¿™ç§å§¿åŠ¿ä¹Ÿå°±å˜è´¨äº†å‘€ï¼å¦‚éœ€è¦è°ƒç”¨30ä¸ªå‡½æ•°å»å¤„ç†ï¼Œé‚£ä¹ˆä½ å¾—éœ€è¦å†™30æ¬¡ `x = fnn(x)` ï¼Œè€Œè¿™ç®€ç›´å°±æ˜¯ä½“åŠ›æ´»å‘€ï¼ -> **è¿™ä¸¤ç§å§¿åŠ¿å½¢å¼ä¸Šéƒ½ä¸å¥½çœ‹ï¼**

å‡å¦‚å­˜åœ¨ä¸€ä¸ªAPIï¼Œå¯ä»¥è¿™æ ·ï¼š

``` js
compose(fn1, fn2, fn1, fn3)(5) //16
```

å²‚ä¸æ˜¯è®©äººæ„Ÿåˆ°ç¾æ»‹æ»‹ï¼Ÿ

æ‰€ä»¥æˆ‘ä»¬è¯¥å¦‚ä½•å®ç°è¿™ä¸ª `compose` å‡½æ•°å‘¢ï¼Ÿ

compose -> å‡½æ•°è°ƒç”¨çš„æ‰å¹³åŒ– -> æŠŠåµŒå¥—è°ƒç”¨ï¼Œå˜æˆæ˜¯ä¸€ä¸ªä¸ªåŒçº§å‚æ•°è°ƒç”¨

è¯è¯´ï¼Œä½•ä¸ºæ‰å¹³åŒ–ï¼Ÿ

``` js
// å±‚çº§åµŒå¥—
console.log(fn3(fn1(fn2(fn1(5)))));

// åŒä¸€çº§å†™å³ä¸ºæ‰å¹³åŒ–
compose(fn1, fn2, fn1, fn3)(5)
```

ç®€å•æ¥è¯´ï¼Œæœ¬æ¥ä½ æ˜¯èµ°æ¥¼æ¢¯ä¸‹å»çš„ï¼Œå¯æ˜¯ä½ ç”¨æŸç§æ‰‹æ®µå±…ç„¶æŠŠæ¥¼æ¢¯å˜æˆäº†æ»‘æ¢¯ï¼Œä½ çœ‹åŒæ ·æ˜¯ä¸‹å»ï¼Œåæ»‘æ¢¯å²‚ä¸æ˜¯æ›´èˆ’æœã€æ›´è½»æ¾ï¼Ÿæˆ–è€…ä½ ä¹Ÿå¯ä»¥è®¤ä¸ºæ¥¼æ¢¯æ‰å¹³åŒ–çš„ç»“æœå°±æ˜¯ç”µæ¢¯â€¦â€¦æƒ³è±¡ä¸€ä¸‹ï¼Œä½ ï¼ˆæ˜¯ä¸ªå‚æ•°ï¼‰åœ¨æ¥¼é¡¶ï¼Œæ¯èµ°ä¸€å±‚æ¥¼å°±ç›¸å½“äºåµŒå¥—ä¸€å±‚è°ƒç”¨ï¼Œå½“èµ°å®Œåå±‚æ¥¼åï¼Œä½ å·²ç»æ°”å–˜å˜˜å˜˜äº†ï¼Œè€Œä½ åšç”µæ¢¯çš„è¯ï¼Œä»æ¥¼é¡¶ç›´æ¥åä¸‹æ¥ï¼Œç®€ç›´so easyï¼

![æ‰å¹³åŒ–å›¾ç¤º](assets/img/2020-05-29-17-40-45.png)

> æŠŠä¸€å±‚å±‚æ¥¼çœ‹æˆæ˜¯ä¸€ä¸ªä¸ªå‡½æ•°è°ƒç”¨

è¯åˆè¯´å›æ¥ï¼Œ compose çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

![composeæ‰§è¡Œè¿‡ç¨‹](assets/img/2020-05-29-18-58-46.png)

## â˜…å¦‚ä½•å†™è¿™ä¸ªä¸œè¥¿ï¼Ÿ

ä¸€æ­¥æ­¥æ¥çœ‹ï¼š

``` js
// ä»€ä¹ˆéƒ½ä¸ä¼ ï¼Œç›´æ¥è¿”å›5
compose()(5); // -> 5

// ä¼ ä¸€ä¸ªå‡½æ•°å°±æ‰§è¡Œä¸€ä¸ªå‡½æ•°
compose(fn1)(5); // -> fn1(5) -> 15

// ä¼ å¤šä¸ªå°±æ‰§è¡Œå¤šä¸ª
compose(fn1, fn2)(5); // -> fn1(5) -> fn2(15) -> 150
compose(fn1, fn2, fn1)(5); // â€¦â€¦
compose(fn1, fn2, fn1, fn3)(5);
```

> `compose` ä¹Ÿæ˜¯ä¾æ‰˜äºæŸ¯é‡ŒåŒ–å‡½æ•°ç¼–ç¨‹æ€æƒ³è¿›ä¸€æ­¥æ·±é€ å‡ºæ¥çš„ä¸œè¥¿

### â—‡å†™è¿™ä¸ªä¸œè¥¿çš„æ­¥éª¤é¡ºåº

#### 1ã€æŸ¯é‡ŒåŒ–å‡½æ•°ç¼–ç¨‹æ€æƒ³

``` js
 function compose(...funcs) {
   return function proxy() {};
 }
```

#### 2ã€ç¡®å®šå‚æ•°

``` js
function compose(...funcs) {
  // -> funcs:ä¼ é€’çš„å‡½æ•°é›†åˆ
  return function proxy(...args) {
    // -> args:ç¬¬ä¸€æ¬¡è°ƒç”¨å‡½æ•°ä¼ é€’çš„å‚æ•°é›†åˆ
  };
}
```

> ä¼ ç»™ç¬¬ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ï¼Œå¯èƒ½æœ‰å¤šä¸ª

#### 3ã€ç‰¹æ®Šæƒ…å†µå¤„ç†ï¼šä¸ä¼ å‡½æ•°ã€åªä¼ ä¸€ä¸ªå‡½æ•°

``` js
function compose(...funcs) {
  // -> funcs:ä¼ é€’çš„å‡½æ•°é›†åˆ
  return function proxy(...args) {
    // -> args:ç¬¬ä¸€æ¬¡è°ƒç”¨å‡½æ•°ä¼ é€’çš„å‚æ•°é›†åˆ
    let len = funcs.length;
    if (len === 0) {
      // -> ä¸€ä¸ªå‡½æ•°éƒ½ä¸éœ€è¦æ‰§è¡Œï¼Œç›´æ¥è¿”å›args
      return args;
    }
    if (len === 1) {
      // -> åªéœ€è¦æ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼ŒæŠŠå‡½æ•°æ‰§è¡Œï¼ŒæŠŠå…¶ç»“æœè¿”å›å‡ºå»å³å¯
      return funcs[0](...args);
    }
  };
}
```

#### 4ã€ç‰¹æ®Šæƒ…å†µå¤„ç†ï¼šä¼ å¤šä¸ªå‡½æ•°å‘¢ï¼Ÿå³ä¼ 2ä¸ªæˆ–2ä¸ªä»¥ä¸Šçš„å‡½æ•°è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ

> å¦‚ä½•å®ç°è¿™ç§æ“ä½œï¼š `fn1(...args)` -> è¿”å›å€¼ `xxx` -> `fn2(xxx)` ï¼Œè€Œä¸”è¿™ç§æ“ä½œè¦ä¸€ç›´ä¸‹å»ï¼Œç›´åˆ°æ»¡è¶³æŸç§æ¡ä»¶å°±ç»“æŸ

åˆ©ç”¨reduceè¿™ä¸ªæ•°ç»„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ï¼š

![reduce & compose](assets/img/2020-05-29-21-53-42.png)

> çœ‹åˆ°reduceå’©æœ‰ä¼ ç¬¬äºŒä¸ªå‚æ•°ï¼Œé‚£ä¹ˆç¬¬ä¸€ååº”æ˜¯ï¼Œcallbackçš„xã€yåˆ†åˆ«æ˜¯`fn1`å’Œ`fn2`ï¼Œç›´åˆ°yä¸ºæœ€åä¸€ä¸ªå…ƒç´ å€¼ï¼Œç»“æŸreduceçš„å¤„ç†ï¼ -> å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ç»“æœ
> 
> åœ¨æ²¡æœ‰reduceè¿™ä¸ªAPIä¹‹å‰ï¼Œå®ç°å‡½æ•°è°ƒç”¨çš„æ‰å¹³åŒ–éœ€è¦æ‰‹æ’¸ä¸€ä¸ªreduceï¼Œå½“ç„¶ï¼Œè¿™ä¸éœ€è¦100%å®ç°ï¼Œåªè¦æ»¡è¶³ä¸Šè¾¹ä½“ç°å‡ºæ¥çš„åŠŸèƒ½å³å¯ï¼

ä¼˜åŒ–ä¸€ä¸‹ï¼š

``` js
function compose(...funcs){
    return function(...args){
        let result,
            len=funcs.length;
        if(len===0){
            result=args;
        }else if(len===1){
            result=funcs[0](...args);
        }else{
            result=funcs.reduce((x, y) => {
                return typeof x === 'function' ? y(x(...args)) : y(x);
            }); 
        }
        return result;
    }
}
```

---

composeè¿™ä¸œè¥¿åœ¨æˆ‘ä»¬çœŸå®é¡¹ç›®é‡Œè¾¹æ˜¯å¾ˆå¸¸ç”¨çš„ï¼Œæ¯•ç«Ÿæˆ‘ä»¬çš„é¡¹ç›®æ€»ä¼šé‡åˆ°ä¸€ä¸ªå‡½æ•°æ‰§è¡Œå®Œçš„ç»“æœï¼Œä½œä¸ºä¸‹ä¸€ä¸ªå‡½æ•°æ‰§è¡Œçš„å®å‚ï¼Œå¦‚æœå‡½æ•°è°ƒç”¨å±‚çº§æ¯”è¾ƒå¤šçš„è¯ï¼Œæˆ‘ä»¬è‚¯å®šå¾—ç”¨composeè¿™ä¸ªä¸œè¥¿æ¥æï¼ï¼ˆä¸æƒ³å¹²è‹¦åŠ›æ´»å°±ç”¨composeè¿™ä¸ªä¸œè¥¿å§ï¼ï¼‰

å¯¹äº†ï¼Œåœ¨reduxæºç é‡Œè¾¹ä¹Ÿæœ‰ä¸ª`compose.js`æ¨¡å—ï¼š

``` js
function compose(...funcs) {
  if (funcs.length === 0) {
    return arg => arg
  }

  if (funcs.length === 1) {
    return funcs[0]
  }

  return funcs.reduce((a, b) => (...args) => a(b(...args)))
}
```

è¯¥æ¨¡å—ä¸æ˜¯ç›´æ¥returnä¸€ä¸ªå°å‡½æ•°ï¼Œè€Œä¸”æˆ‘ç”¨äº†è¯¥æ¨¡å—å»æµ‹è¯•ï¼Œå‘ç°ç»“æœä¸å¯¹ï¼Œçœ‹äº†æ³¨é‡Šï¼š

``` js
compose(f, g, h)
// <=> 
(...args) => f(g(h(...args)))
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ˜¯å€’è¿‡æ¥çš„ -> ä»æœ€åä¸€ä¸ªå¼€å§‹æ‰§è¡Œï¼Œä»å³å¾€å·¦åµŒå¥—è°ƒç”¨æ‰§è¡Œï¼

ä¸ç®¡æ€æ ·ï¼Œè®°ä½è€å¸ˆè®²çš„é‚£ä¸ªcomposeå°±å¥½äº†ï¼

## â˜…æ€»ç»“

- å½¢å¼ä¸Šæ”¹å˜è¿™ç§å§¿åŠ¿ï¼š `fn(fn1(fn2(fn3('hi'))))` -> `compose(fn3,fn2,fn1,fn)('hi')`

## â˜…Q&A

### <mark>1ï¼‰reduceçš„ç”¨æ³•ï¼Ÿ</mark>

reduceè¯­æ³•ï¼š

``` js
arr.reduce(callback(accumulator, currentValue[, index[, array]])[, initialValue])
```

ä»”ç»†çœ‹æ¥ï¼š

1. ä½ ä½¿ç”¨ `reduce` è¿™ä¸ªAPI

   1. å¿…é¡»ä¼  `callback` 

      1. å¿…é¡»ä¼  `acc` ã€ `cur` 

   2. ä¸ä¼  `initialValue` -> Source Array ( `src` )çš„ç¬¬ä¸€é¡¹å°±æ˜¯callbackçš„ç¬¬ä¸€ä¸ªå‚æ•° `acc` çš„åˆå§‹å€¼

ä¾‹å­ï¼š

``` js
let arr = [10, 16, 30, 66];
arr.reduce((x, y) => {
  console.log(x, y);
  return "@";
});
// 10 16ã€@ 30ã€@ 66
```

è§£æï¼š

åœ¨reduceçš„è‚šå­é‡Œè¾¹ï¼Œä¼šæœ‰ä¸ªforå¾ªç¯åœ¨æ‰§è¡Œè¿™ä¸ªcallbackï¼Œè€Œcallbackçš„è¿”å›å€¼å°±æ˜¯ä¸‹ä¸€è½®å¾ªç¯æ‰§è¡Œcallbackçš„ç¬¬ä¸€ä¸ªå‚æ•°å€¼

ç¬¬ä¸€è½®å¾ªç¯ï¼š

å¦‚æœæˆ‘ä»¬å¯¹reduceä¸ä¼ ç¬¬äºŒä¸ªå‚æ•°ï¼Œé‚£ä¹ˆxçš„åˆå§‹å€¼å°±æ˜¯æ•°ç»„ç¬¬ä¸€é¡¹çš„å€¼ï¼Œæ¯ä¸€æ¬¡callbackè¿”å›çš„ç»“æœä½œä¸ºä¸‹ä¸€æ¬¡xçš„å€¼ï¼Œè€Œyåˆ™æ˜¯æ•°ç»„ç¬¬äºŒé¡¹å€¼

å¦‚æœæˆ‘ä»¬ä¼ äº†ç¬¬äºŒä¸ªå‚æ•°`5`ï¼Œé‚£ä¹ˆxçš„åˆå§‹å€¼å°±æ˜¯`5`ï¼Œè€Œ`10`åˆ™æ˜¯yçš„å€¼â€¦â€¦

æ‰€ä»¥ï¼š

1. `10 16`
2. `@ 30`
3. `@ 66`

yçš„å€¼å§‹ç»ˆæ˜¯æ•°ç»„ä¸­çš„æŸä¸€é¡¹ï¼Œè€Œxåˆ™æ˜¯callbackå¤„ç†è¿‡åçš„è¿”å›å€¼ï¼Œå½“ç„¶ç¬¬ä¸€æ¬¡å¤„ç†æ¯”è¾ƒç‰¹æ®Šï¼Œè¿™å…³ç³»åˆ°å¯¹reduceæœ‰å’©æœ‰ä¼ ç¬¬äºŒä¸ªå‚æ•°ï¼

ä¾‹å­ï¼š

``` js
// å¯¹æ•°ç»„æ¯é¡¹æ±‚å’Œ
  let arr = [10, 16, 30, 66];
      let sum = arr.reduce((x, y) => {
        return x + y;
      });
      console.log(sum); // -> 122
```



â¹ï¼š[Array.prototype.reduce() - JavaScript - MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce)

â¹ï¼š[JS reduceæ–¹æ³•æºç è§£æ - æ˜é‡‘](https://juejin.im/post/5e647b425188252c1f223d61)

â¹ï¼š[æ‰‹å†™ new, call, apply, bind, reduce, curryingï¼Œ é˜²æŠ–èŠ‚æµ æºç ï¼Œå¹¶é…ä¸Šè¯¦ç»†åˆ†æ - æ˜é‡‘](https://juejin.im/post/5eb4c7c96fb9a043807be995#heading-4)






