| ✍️ Tangxt | ⏳ 2020-08-05 | 🏷️ 设计模式 |

# 37-发布订阅设计模式

## ★前言

从服务器获取数据：

1. 数据分析
2. 数据绑定
3. DOM 元素的相关操作
4. ……

元素监听用户行为：

1. 接收到了信号
2. 信号分析
3. 执行 callback
4. 数据绑定
5. DOM 元素的相关操作
6. ……

## ★是什么？

1）概述

> 透过事件池机制，来让你了解什么是「发布订阅设计模式」

我们使用 jQuery 的 ajax 方法，来发送 ajax 请求：

``` js
$.ajax({
  url: '/api/v1/userlist',
  success: function(result) {
    fn1(result)
    fn2(result)
    fn3(result)
  }
})

function fn1() {}

function fn2() {}

function fn3() {}
```

也可以使用 axios：

``` js
axios.get('/api/v1/userlist')
.then(res => {})
.catch((err) => {})
```

也可以使用发布订阅设计模式：

先规划好拿到数据之后，应该要做什么：

把 callback 扔到一个容器里边去 -> `$on(fn1)`、`$on(fn2)` -> 也可以移除 callback（`$off`）

数据拿到之后，直接就这样：

``` js
$.ajax({
  url: '/api/v1/userlist',
  success: function(result) {
    // 依次执行容器里的方法
    $emit(result)
  }
})
```

这种姿势比传统的`$.ajax()`要好！

---

发布订阅设计模式的思想是：

> 事先把要干的事给计划好（把`callback`扔到一个池子里去），当到达指定条件的时候（`ajax`请求成功，响应回来数据）或者说某种信号来了，就依次执行容器里的方法！

![发布订阅设计模式的思想](assets/img/2020-08-07-01-30-14.png)

这同事件池机制一样，监听事件，信号来了，依次执行事件池里的`callback`

补充：

观察者模式 vs 发布订阅模式：

![观察者模式 vs 发布订阅模式](assets/img/2020-08-07-01-44-50.png)

有人这样理解它们二者的区别：

1. 发布-订阅模式就好像报社， 邮局和个人的关系，报纸的订阅和分发是由邮局来完成的。报社只负责将报纸发送给邮局。
2. 观察者模式就好像 个体奶农和个人的关系。奶农负责统计有多少人订了产品，所以个人都会有一个相同拿牛奶的方法。奶农有新奶了就负责调用这个方法。

在我看来：

> 双向绑定的效果可以理解成观察者模式，单向数据流的效果可以理解成发布订阅模式

其实发布者就是资源的生产者，而订阅者就是需要资源的人（也就是消费者），我们是线下面对面交易？还是网上交易？

2）是什么

认识它，你得知道这么几个概念：

1. 发布者 -> 生产者（生产的是`callback`） -> 自定义事件池（`$pond`） -> 也就是自定义的一个容器 -> 注意这可不是浏览器内置的事件哈！
2. 订阅者 -> 买家（监听某个信号`$on()`），买家还可以退货（移除某个信号的`callback`，`$off()`）
3. 中介 -> 网店，通知买家收费（发布某个信号，`$emit()/fire()`，为何发布？因为「发布者」把东西生产出来了）

## ★写一个

1）为啥要用面向对象姿势封装插件？

2）ES6 的 class 语法、装饰器

3）写一个体现发布订阅设计模式思想的代码

> 老师并没有弄三个class出来，直接就是用三个API来代表三种操作！

1. 自执行函数
2. 创建 `Sub` -> 定义原型方法，也就是定义「API 接口」 -> `$pond、$on、$off、$emit` -> 这些 API 的设计是仿照 Vue 的 eventBus
3. `new Sub` -> 使用
